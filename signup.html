<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign Up - MY FLY CLOUDLY TOURS</title>
    <!-- Google Fonts - Brand Typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@900&family=Public+Sans:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>

<body class="auth-page">
    <!-- Navigation (will be replaced by navbar.js) -->
    <nav class="navbar"></nav>

    <!-- Animated Sky Background -->
    <div class="sky-background">
        <div class="cloud cloud-1"></div>
        <div class="cloud cloud-2"></div>
        <div class="cloud cloud-3"></div>
        <div class="airplane-icon">‚úàÔ∏è</div>
    </div>

    <!-- Sign Up Form -->
    <section class="auth-section">
        <div class="container">
            <div class="auth-container">
                <div class="auth-card modern-auth-card">
                    <div class="auth-header">
                        <div class="auth-icon">üöÅ</div>
                        <h1 data-i18n="auth.createAccount">Create Account</h1>
                        <p data-i18n="auth.signUpDescription">Sign up to start booking your flight experiences</p>
                    </div>
                    <form id="signupForm" class="auth-form">
                        <div class="form-group">
                            <label for="fullName" data-i18n="auth.fullName">Full Name</label>
                            <input type="text" id="fullName" name="fullName" placeholder="John Doe" required>
                        </div>
                        <div class="form-group">
                            <label for="email" data-i18n="auth.email">Email Address</label>
                            <input type="email" id="email" name="email" placeholder="your.email@example.com" required>
                        </div>
                        <div class="form-group">
                            <label for="phone" data-i18n="auth.phoneNumber">Phone Number (Optional)</label>
                            <input type="tel" id="phone" name="phone" placeholder="+60123456789">
                        </div>
                        <div class="form-group">
                            <label for="nationality" data-i18n="auth.nationality">Nationality *</label>
                            <select id="nationality" name="nationality" required>
                                <option value="" data-i18n="auth.selectNationality">Select your nationality</option>
                            </select>
                            <small class="form-help">Required for booking verification</small>
                        </div>
                        <div class="form-group">
                            <label for="password" data-i18n="auth.password">Password</label>
                            <div class="password-input-wrapper">
                                <input type="password" id="password" name="password" placeholder="Minimum 8 characters"
                                    minlength="8" required>
                                <button type="button" class="password-toggle" onclick="togglePassword('password')"
                                    aria-label="Toggle password visibility">
                                    <span class="eye-icon">üëÅÔ∏è</span>
                                </button>
                            </div>
                            <small class="form-help" data-i18n="auth.passwordHelp">Must be at least 8 characters long</small>
                        </div>
                        <div class="form-group">
                            <label for="confirmPassword" data-i18n="auth.confirmPassword">Confirm Password</label>
                            <div class="password-input-wrapper">
                                <input type="password" id="confirmPassword" name="confirmPassword"
                                    placeholder="Re-enter your password" required>
                                <button type="button" class="password-toggle"
                                    onclick="togglePassword('confirmPassword')" aria-label="Toggle password visibility">
                                    <span class="eye-icon">üëÅÔ∏è</span>
                                </button>
                            </div>
                        </div>
                        <div id="errorMessage" class="error-message" style="display: none;"></div>
                        <button type="submit" class="btn btn-primary btn-block">
                            <span class="btn-text" data-i18n="auth.createAccount">Create Account</span>
                            <span class="btn-loader" style="display: none;" data-i18n="common.loading">Creating...</span>
                        </button>
                        
                        <!-- Divider -->
                        <div class="auth-divider">
                            <span data-i18n="common.or">or</span>
                        </div>
                        
                        <!-- Google Sign In Button -->
                        <button type="button" class="btn btn-google btn-block" onclick="handleGoogleSignIn()">
                            <svg width="18" height="18" viewBox="0 0 18 18" style="margin-right: 8px;">
                                <path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z"/>
                                <path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.96-2.184l-2.908-2.258c-.806.54-1.837.86-3.052.86-2.347 0-4.33-1.584-5.04-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z"/>
                                <path fill="#FBBC05" d="M3.96 10.707c-.18-.54-.282-1.117-.282-1.707s.102-1.167.282-1.707V4.961H.957C.348 6.175 0 7.55 0 9s.348 2.825.957 4.039l3.003-2.332z"/>
                                <path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.961L3.96 7.293C4.67 5.163 6.653 3.58 9 3.58z"/>
                            </svg>
                            <span data-i18n="auth.continueWithGoogle">Continue with Google</span>
                        </button>
                    </form>
                    <div class="auth-footer">
                        <p><span data-i18n="auth.alreadyHaveAccount">Already have an account?</span> <a href="login.html" data-i18n="auth.loginHere">Login here</a></p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer (will be replaced by footer.js) -->
    <footer class="footer-modern"></footer>

    <!-- GSAP Animation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>

    <!-- Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/nationalities.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/translations.js"></script>
    <script src="js/i18n.js"></script>
    <script src="js/navbar.js"></script>
    <script src="js/footer.js"></script>
    <script src="js/main.js"></script>
    <script>
        // Initialize navbar and footer
        document.addEventListener('DOMContentLoaded', () => {
            initRegularNavbar('signup.html');
            initFooter();
            applyTranslations(); // Apply translations after content is loaded
            if (typeof populateNationalitySelect === 'function') populateNationalitySelect('nationality');
            // Force navbar to be solid
            const navbar = document.querySelector('.navbar');
            if (navbar) {
                navbar.classList.add('scrolled');
            }

            // Animate auth card entrance
            if (typeof gsap !== 'undefined') {
                const authCard = document.querySelector('.modern-auth-card');
                if (authCard) {
                    gsap.set(authCard, { opacity: 0, y: 50, scale: 0.9 });
                    gsap.to(authCard, {
                        opacity: 1,
                        y: 0,
                        scale: 1,
                        duration: 0.8,
                        ease: 'back.out(1.7)',
                        delay: 0.2
                    });
                }

                // Animate form inputs
                const inputs = document.querySelectorAll('.form-group input');
                inputs.forEach((input, index) => {
                    gsap.set(input, { opacity: 0, x: -20 });
                    gsap.to(input, {
                        opacity: 1,
                        x: 0,
                        duration: 0.5,
                        delay: 0.4 + (index * 0.1),
                        ease: 'power2.out'
                    });
                });
            }
        });

        // Password toggle function
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const toggleBtn = input.nextElementSibling;
            const eyeIcon = toggleBtn.querySelector('.eye-icon');

            if (input.type === 'password') {
                input.type = 'text';
                eyeIcon.textContent = 'üôà';
                toggleBtn.setAttribute('aria-label', 'Hide password');
            } else {
                input.type = 'password';
                eyeIcon.textContent = 'üëÅÔ∏è';
                toggleBtn.setAttribute('aria-label', 'Show password');
            }
        }

        // Google Sign In Handler
        async function handleGoogleSignIn() {
            const errorDiv = document.getElementById('errorMessage');
            try {
                if (!supabase) {
                    showError(errorDiv, 'Supabase not initialized. Please refresh the page.');
                    return;
                }

                const { data, error } = await signInWithGoogle();
                
                if (error) {
                    showError(errorDiv, error.message || 'Failed to sign in with Google. Please try again.');
                    return;
                }

                // The OAuth flow will redirect, so we don't need to handle success here
                // The redirect will go to auth-callback.html which we'll create
            } catch (error) {
                console.error('Google sign-in error:', error);
                showError(errorDiv, 'An error occurred. Please try again.');
            }
        }
    </script>
    <script>
        // Wait for Supabase to load
        setTimeout(() => {
            // Handle signup form submission
            document.getElementById('signupForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const fullName = formData.get('fullName').trim();
                const email = formData.get('email').trim();
                const phone = formData.get('phone').trim();
                const nationality = formData.get('nationality');
                const password = formData.get('password');
                const confirmPassword = formData.get('confirmPassword');
                const errorDiv = document.getElementById('errorMessage');
                const submitBtn = e.target.querySelector('button[type="submit"]');

                // Validate inputs
                if (!fullName) {
                    showError(errorDiv, 'Please enter your full name');
                    return;
                }

                if (!isValidEmail(email)) {
                    showError(errorDiv, 'Please enter a valid email address');
                    return;
                }

                if (!nationality) {
                    showError(errorDiv, 'Please select your nationality');
                    return;
                }

                if (password.length < 8) {
                    showError(errorDiv, 'Password must be at least 8 characters long');
                    return;
                }

                if (password !== confirmPassword) {
                    showError(errorDiv, 'Passwords do not match');
                    return;
                }

                // Show loading
                showButtonLoading(submitBtn);
                hideMessage(errorDiv);

                // Sign up
                const { data, error } = await signUp(email, password, fullName, phone || null, nationality);

                if (error) {
                    hideButtonLoading(submitBtn);
                    let errorMessage = '';

                    // Handle specific Supabase errors
                    if (error.message) {
                        // Use the improved error message from auth.js
                        errorMessage = error.message;
                    } else {
                        errorMessage = 'Failed to create account. Please try again.';
                    }

                    showError(errorDiv, errorMessage);
                    console.error('Signup error:', error); // For debugging
                    return;
                }

                if (data) {
                    // Check if user is already logged in (email confirmation disabled)
                    const user = getCurrentUser();
                    if (user) {
                        // User is logged in - go to dashboard
                        showSuccess(errorDiv, 'Account created successfully! Redirecting to dashboard...');
                        setTimeout(() => {
                            window.location.href = 'dashboard.html';
                        }, 1500);
                    } else {
                        // Email confirmation required - go to login
                        showSuccess(errorDiv, 'Account created! Please check your email to confirm, then login.');
                        setTimeout(() => {
                            window.location.href = 'login.html';
                        }, 2000);
                    }
                }
            });
        }, 500);
    </script>
</body>

</html>